<!DOCTYPE html>
<html lang="en">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <!-- <link rel='stylesheet' type='text/css' href='https://cdn.rawgit.com/MarsUniversity/ece387/master/website/pandoc.css'> -->
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script>
    	<link href="https://cdnjs.cloudflare.com/ajax/libs/cc-icons/1.2.1/css/cc-icons.min.css" rel="stylesheet">
    	<link href="https://cdn.rawgit.com/walchko/font-linux/v0.7.2/assets/font-linux.css" rel="stylesheet">
      <!-- <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous"> -->
      <link href="https://fonts.googleapis.com/css?family=Source+Serif+Pro" rel="stylesheet">
      <link href="https://walchko.github.io/site.css" rel="stylesheet" type="text/css" />
      <!-- <link href="../../site.css" rel="stylesheet" type="text/css" /> -->
    	<!-- <link href="https://walchko.github.io/pygments.css" rel="stylesheet" type="text/css" /> -->
      <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [["$","$"],["\\(","\\)"]]
          }
        });
      </script>

	  <!-- code pulled from jupyter nbconvert for syntax coloring -->
	  <style type="text/css">
    .highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */
    </style>

    </head>
    <body>
      <div id="outer-wrapper">
        <div id="header-wrapper">
  <div class="title xtralarge bold"><a href="https://walchko.github.io/index.html">Planet Express</a></div>
  <div class="normal small"> Our crew is replaceable. Your package isn't. </div>

  <div class="nav normal">
    <a class="logo" href="https://walchko.github.io/index.html">Home</a>
    <a class="logo" href="https://walchko.github.io/colophon.html">Colophon</a>
    <a class="logo" href="https://walchko.github.io/about.html">About</a>
    <a class="logo" href="https://walchko.github.io/topics.html">Topics</a>
  </div>
</div>


          <div id="main">
            
            
              <h1 id="quadruped-robot">Quadruped Robot</h1>
<dl>
<dt>date</dt>
<dd><p>2016-07-11</p>
</dd>
<dt>modified</dt>
<dd><p>2016-07-31</p>
</dd>
<dt>summary</dt>
<dd><p>Simple quadruped made from a 3d printed body and 9 gram micro servos (TG9e).</p>
</dd>
</dl>
<figure>
<img src="pics/rc-spider-1.jpg" class="align-center" width="400" />
</figure>
<h2 id="kinematics">Kinematics</h2>
<h3 id="useful-trigonometry">Useful Trigonometry</h3>
<figure>
<img src="pics/law_cosines.png" class="align-center" />
</figure>
<p>The <strong>law of cosines</strong> for calculating one side of a triangle when the angle opposite and the other two sides are known. Can be used in conjunction with the law of sines to find all sides and angles.</p>
<h3 id="forward-kinematics">Forward Kinematics</h3>
<p>Forward kinematics produces the position (x,y,z) of the foot given the angles of the leg segment joints. We will use the following parameters (from the real robot) and nomenclature</p>
<table>
<thead>
<tr class="header">
<th>Leg Segment</th>
<th>Symbol</th>
<th>Length</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Coxa</td>
<td><span class="math inline"><em>L</em><sub><em>c</em><em>o</em><em>x</em><em>a</em></sub></span> or <span class="math inline"><em>L</em><sub><em>c</em></sub></span></td>
<td>26 mm</td>
</tr>
<tr class="even">
<td>Femur</td>
<td><span class="math inline"><em>L</em><sub><em>f</em><em>e</em><em>m</em><em>u</em><em>r</em></sub></span> or <span class="math inline"><em>L</em><sub><em>f</em></sub></span></td>
<td>45 mm</td>
</tr>
<tr class="odd">
<td>Tibia</td>
<td><span class="math inline"><em>L</em><sub><em>t</em><em>i</em><em>b</em><em>i</em><em>a</em></sub></span> or <span class="math inline"><em>L</em><sub><em>t</em></sub></span></td>
<td>63 mm</td>
</tr>
</tbody>
</table>
<figure>
<img src="pics/Robot_Leg.png" alt="The figure on the left is for the forward kinematics, while the figure on the right helps show how the inverse kinematics was developed." class="align-center" /><figcaption>The figure on the left is for the forward kinematics, while the figure on the right helps show how the inverse kinematics was developed.</figcaption>
</figure>
<p>The forward kinematics will follow the Denavit–Hartenberg process<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. The foot position is:</p>
<p><br /><span class="math display">$$\begin{aligned}
\begin{bmatrix}
    L_c \cos \alpha + L_f \cos \alpha \cos \beta + L_t (-\sin \beta \sin \gamma \cos \alpha + \cos \alpha \cos \alpha \cos \beta \cos \gamma) \\
    L_c \sin \alpha + L_f \sin \alpha \cos \beta + L_t (-\sin \alpha \sin \beta \sin \gamma + \sin \alpha \cos \cos \beta \cos \gamma) \\
    L_f \sin \beta + L_t (\sin \beta \cos \gamma + \sin \gamma \cos \beta)
\end{bmatrix}
\end{aligned}$$</span><br /></p>
<h3 id="inverse-kinematics">Inverse Kinematics</h3>
<p>Often, we need to find the angles of the leg joints given a location (x,y,z) of the foot. To calculate this, remember the leg is composed of 3 revolute joints. The shoulder is in one plane and both the femur joint and tibia joint are in another plane. The tote project<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> helped with developing the inverse kinematics, however, there were some errors in those equations.</p>
<p>So let's start with the shoulder, look down from the top, we see the x-y plane. We can calculate the it's rotation <span class="math inline"><em>α</em></span> by using x and y of the foot location.</p>
<p><br /><span class="math display"><em>α</em> = <em>a</em><em>t</em><em>a</em><em>n</em>2(<em>y</em>, <em>x</em>)</span><br /></p>
<p>Next, let's look at the plane which the next 2 joints lie in. Now we will calculate the <span class="math inline"><em>β</em></span> and <span class="math inline"><em>γ</em></span> angles.</p>
<p><br /><span class="math display">$$\begin{aligned}
m = \sqrt{x^2 + y^2} \\
 f = m - L_{coxa} \\
 \beta_1 = atan2(f,z) \\
 d = \sqrt{f^2 + z^2} \\
 \beta_2 = \arccos( \frac{L_{femur}^2+d^2-L_{tibia}^2}{2 d L_{femur}} ) \\
 \beta = \beta_1 + \beta_2
 \gamma = \arccos( \frac{L_{femur}^2+L_{tibia}^2-d^2}{2 L_{femur} L_{tibia}} )
\end{aligned}$$</span><br /></p>
<p>Now finally, you should notice the definition for <span class="math inline"><em>γ</em></span> is different between forward and reverse kinematics. So let's fix that ...</p>
<p><br /><span class="math display">$$\begin{aligned}
\gamma_{fk} = \gamma_{ik} - \pi \\
 \beta_{fk} = \beta_{ik} - \pi/2
\end{aligned}$$</span><br /></p>
<h2 id="gait">Gait</h2>
<table>
<tbody>
<tr class="odd">
<td>k</td>
<td>step</td>
</tr>
<tr class="even">
<td>i</td>
<td>leg</td>
</tr>
<tr class="odd">
<td><span class="math inline"><em>p</em><sub><em>i</em></sub></span></td>
<td>x,y,z position of leg</td>
</tr>
<tr class="even">
<td><span class="math inline"><em>ϕ</em><sub><em>i</em>, <em>k</em></sub></span></td>
<td>gait foot position for leg i at step k</td>
</tr>
<tr class="odd">
<td><span class="math inline"><em>z</em><sub><em>i</em></sub></span></td>
<td>height modifier of leg i</td>
</tr>
<tr class="even">
<td><span class="math inline"><em>R</em><sub><em>z</em></sub></span></td>
<td>rotation matrix around z axis</td>
</tr>
</tbody>
</table>
<p>Gaits for robots follows that of animals. There is a rhythmic repetitive pattern that they use and we will exploit here. The gait is based on the work of Metal<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a> with some differences.</p>
<table>
<thead>
<tr class="header">
<th>k</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>10</th>
<th>11</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline"><em>ϕ</em><sub>1, <em>k</em></sub></span></td>
<td>9/9</td>
<td>6/9</td>
<td>3/9</td>
<td>0/9</td>
<td>1/9</td>
<td>2/9</td>
<td>3/9</td>
<td>4/9</td>
<td>5/9</td>
<td>6/9</td>
<td>7/9</td>
<td>8/9</td>
</tr>
<tr class="even">
<td><span class="math inline"><em>z</em><sub>1</sub></span></td>
<td>0.1</td>
<td>0.2</td>
<td>0.2</td>
<td>0.1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>Each leg executes this pattern in the order of: 0, 2, 1, 3. This leads to a stable tripod gait. Each leg is at a different point of this gait, denoted by an offset. The offset of each leg is:</p>
<table>
<thead>
<tr class="header">
<th>leg</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>offset</td>
<td>0</td>
<td>6</td>
<td>3</td>
<td>9</td>
</tr>
</tbody>
</table>
<p>Thus at time 0, Leg 0 is at the beginning (k=0), Leg 1 is at k=6, etc.</p>
<p>The quadruped's linear and rotational movements are decoupled. The equation below shows how the y axis movement is calculated, but the x axis equation is the same. Basically, the <span class="math inline"><em>Δ</em></span> is the delta change in leg position from the normal or resting leg position.</p>
<p><br /><span class="math display">$$\begin{aligned}
\delta(x,y) = linear(x,y) + rotational(x,y) \\
 \Delta_{i,k} = \delta(x,y)/2 - \phi_{i,k} \delta(x,y)
\end{aligned}$$</span><br /></p>
<p>where the i identifies the leg (<span class="math inline"><em>i</em> ∈ [0, 1, 2, 3]</span>), k is the step (<span class="math inline"><em>k</em> ∈ [0, 1, …11]</span>) and linear/rotation are the commanded linear or rotation movements of the robot.</p>
<p>Now each leg exists in its own leg reference frame. Each leg frame is rotated 45 degrees around the robot. The</p>
<p>The rotation part is handled by taking the normal leg position (x,y,z), rotating it about the z axis and calculating the delta difference by subtracting off the original position.</p>
<p><br /><span class="math display">$$\begin{aligned}
R_z (\theta)=
 \begin{bmatrix}
     \cos(\theta) &amp; -\sin(\theta) &amp; 0 \\
     \sin(\theta) &amp; \cos(\theta) &amp; 0 \\
     0 &amp; 0 &amp; 1
 \end{bmatrix} \\
 rotational(x,y) = R_z(\theta) p_i - p_i
\end{aligned}$$</span><br /></p>
<p>Finally, the new leg position is:</p>
<p><br /><span class="math display"><em>p</em><sub><em>i</em></sub>′ = <em>p</em><sub><em>i</em></sub> + <em>Δ</em><sub><em>i</em>, <em>k</em></sub></span><br /></p>
<h2 id="lessons-learned">Lessons Learned</h2>
<h3 id="servos">Servos</h3>
<p>Toy RC servos have issues:</p>
<ul>
<li>Every servo brand has different range of motion and pulse width timing since there is no real standard of what pulse width is what angle. There is a loose understanding that RC servo manufacturers shoot for. However, if they are off, then the end user has to adjust their system.</li>
<li><p>Every servo even within the same brand has a different range of motion</p>
<blockquote>
<ul>
<li>A pulse width of 1.5 msec on one servo might be 90 degrees on one servo, but 84 deg on another and 100 on another. It is painful to account for all servo biases across a lot of servos (if you are trying to do high accuracy positioning)</li>
</ul>
</blockquote></li>
<li><p>Quality is an issue too, I had one servo die instantly on me and another is beginning to go. Also, I question if they are really meeting their torque performance specification.</p>
<blockquote>
<ul>
<li><p>The micros have very low torque, but should be enough for what I am doing, however, they seem to struggle at times when they shouldn't.</p>
<blockquote>
<ul>
<li>Again, I bought the cheapest servos I could find.</li>
</ul>
</blockquote></li>
</ul>
</blockquote></li>
</ul>
<p>Power:</p>
<ul>
<li>Try to keep your RPi on a different power bus than your motors. I had to put a lot of capacitance in to account for large motor draws, but 1 out of a 100 times there is a small hiccup that resets my system ... it isn't common, but annoying.</li>
</ul>
<h3 id="suggestions">Suggestions</h3>
<ul>
<li><p>Avoid RC servos if possible. My TG9e servos were bought for $2.15 each, but I think I wasted a lot of time because of them.</p>
<blockquote>
<ul>
<li>Use robot servos like DYNAMIXEL AX-12 ($44 each) or XL-320 ($22 each) which are much more advanced and <em>should</em> overcome many of the issues above (e.g., performance, quality, standards) I noted above. Most university level robotic systems use them and for good reason.</li>
</ul>
</blockquote></li>
</ul>
<h2 id="references">References</h2>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p><a href="https://en.wikipedia.org/wiki/Denavit%E2%80%93Hartenberg_parameters">https://en.wikipedia.org/wiki/Denavit%E2%80%93Hartenberg_parameters</a><a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p><a href="https://tote.readthedocs.io/en/latest/ik.html" class="uri">https://tote.readthedocs.io/en/latest/ik.html</a><a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p>Metal, Martin, &quot;Quadrupedal walking robot, statically balanced walker,&quot; found PDF on internet somewhere.<a href="#fnref3" class="footnote-back">↩</a></p></li>
</ol>
</section>

            
          </div>

        </div>
    </body>

    <div id="footer-wrapper">

  <div class="logo"></div>

  <div class="logo">
    <a class="logo" href="http://github.com/walchko"><i class="fl-github fl-36"></i></a>
    <a class="logo" href="http://stackoverflow.com/users/5374768/kevin"><i class="fl-stackoverflow fl-36"></i></a>
    <a class="logo" href="http://raspberrypi.stackexchange.com/users/1677/kevin"><i class="fl-stackexchange fl-36"></i></a>
    <a class="logo" href="https://www.npmjs.com/~kevin.walchko"><i class="fl-npm fl-36"></i></a>
    <a class="logo" href="https://pypi.python.org/pypi"><i class="fl-python fl-36"></i></a>
    <a class="logo" href="https://bitbucket.org/walchko/"><i class="fl-bitbucket fl-36"></i></a>
  </div>

  <div class="logo">
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
      <i class="cc cc-by-sa cc-lg"></i>
    </a>
  </div>

  <div class="pure-u-1">
    <a class="logo" href="https://github.com/walchko/pelican">&copy;&nbsp;2016&nbsp;Kevin J. Walchko</a>
  </div>

</div>


</html>
